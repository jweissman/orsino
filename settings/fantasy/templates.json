{
  "town": {
    "terrain": "=lookup(terrains, 1d6)",
    "size": "=oneOf(hamlet, village, town, city, metropolis, capital)",
    "race":"=oneOf(human, elf, dwarf, halfling, gnome, fae, orc)",
    "deity": "=oneOf(lookup(deity, #race))",
    "capital": "=#size == 'capital'",
    "population": "=eval(lookup(townPop, #size))",
    "_aspect": "=lookup(terrainFeatures, #terrain)",
    "_suffix": "=oneOf(ford, haven, burg, port, dale, keep, watch, gate, rest, fall, ridge, wood, field, pass, hold, stead, view, point, hill, bay, cliff, cross, run, land)",
    "name": "=capitalize(#_aspect + #_suffix)",
    "adjective": "=oneOf(peaceful, bustling, prosperous, decaying, ancient, vibrant, sleepy, lively, fair, grim, quaint, thriving, quiet, rustic, quaint, noble, humble, proud)"
  },
  "pc": {
    "background": "=oneOf(noble, soldier, outlander, scholar, criminal, artisan, acolyte, hermit)",
    "_hometown": "=gen(town)",
    "hometown": "=capitalize(dig(#_hometown, 'size')) + ' of ' + dig(#_hometown, 'name')",
    "gender": "=oneOf(male, female, neutral)",
    "race": "=oneOf(human, orc, elf, dwarf, halfling, gnome, fae)",
    "class": "=oneOf(warrior, mage, thief, cleric, bard, ranger)",
    "age": "=16 + 2d20 + if(#race == \"elf\", 100, if(#race == \"dwarf\", 50, 0))",
    "_surname": "=lookup(surname, #class)",
    "forename": "=lookup(name, #gender)",
    "name": "=#forename + \" \" + #_surname",
    "str": "=rollWithDrop(4, 6)",
    "dex": "=rollWithDrop(4, 6)",
    "int": "=rollWithDrop(4, 6)",
    "wis": "=rollWithDrop(4, 6)",
    "cha": "=rollWithDrop(4, 6)",
    "con": "=rollWithDrop(4, 6)",
    "hitDie": "=lookup(hitDie, #class)",
    "maxHp": "=#hitDie",
    "level": 1,
    "xp": 0,
    "weapon": "=oneOf(lookup(weapon, #class))",
    "_weaponStat": "=lookup(masterWeapon, #weapon)",
    "damageKind": "=dig(#_weaponStat, 'type')",
    "attackDie": "=dig(#_weaponStat, 'damage')",
    "armor": "=lookup(armor, #class)",
    "ac": "=10 - lookup(masterArmor, #armor)",
    "gp": "=1d100",
    "hasMissileWeapon": "=!!dig(#_weaponStat, 'missile')",
    "hasInterceptWeapon": "=!!dig(#_weaponStat, 'intercept')",
    "primaryAttack": "=if(#hasMissileWeapon, 'ranged', 'melee')",
    "abilities": "=concat(#primaryAttack, lookup(abilities, #class))",
    "traits": "=lookup(traits, #race)",
    "*backgroundModifier": "=lookup(backgroundModifier, #background)",
    "*racialModifier": "=lookup(racialModifier, #race)",
    "hp": "=#maxHp",
    "gear": "=gather(masterGear, 2d4 + 1)"
  },

  "animal": {
    "challenging": false,
    "gender": "=oneOf(male, female, neutral)",
    "background": "=oneOf(wild, trained, companion, show, war)",
    "terrain": "=oneOf(forest, cave, swamp, mountain, snow, desert)",
    "race": "=oneOf(goblin, kobold, orc, human, ogre, troll, dragon, human, elf, dwarf, halfling, gnome, fae)",
    "age": "=5+1d10",
    "animal_type": "=lookup(companionType, #race)",
    "forename": "=lookup(companionName, #animal_type)",
    "animal_aspect": "=lookup(creatureAspectTypes, if(#challenging, oneOf(rare, legendary), oneOf(common, uncommon)))",
    "description": "=capitalize(#animal_aspect) + ' ' + capitalize(#terrain) + ' ' + capitalize(#animal_type)",
    "name": "=capitalize(#forename) + \", \" + capitalize(#description)",
    "_statLine": "=lookup(animalStat, #animal_type)",
    "_statBase": 3,
    "level": 1,
    "str": "=dig(#_statLine, 'str')+#_statBase+round(#level/8)",
    "dex": "=dig(#_statLine, 'dex')+#_statBase+round(#level/8)",
    "con": "=dig(#_statLine, 'con')+#_statBase+round(#level/8)",
    "int": "=dig(#_statLine, 'int')+#_statBase+round(#level/8)",
    "wis": "=dig(#_statLine, 'wis')+#_statBase+round(#level/8)",
    "cha": "=dig(#_statLine, 'cha')+#_statBase+round(#level/8)",
    "maxHp": "=dig(#_statLine, 'hp')+ statMod(#con)+ round(#level/4)",
    "weapon": "=lookup(animalWeapon, #animal_type)",
    "hasMissileWeapon": false,
    "_weaponStat": "=lookup(masterWeapon, #weapon)",
    "damageKind": "=dig(#_weaponStat, 'type')",
    "attackDie": "=dig(#_weaponStat, 'damage')",
    "_naturalArmor": "=lookup(animalNaturalArmor, #animal_type)",
    "ac": "=10 - #_naturalArmor",
    "abilities": ["melee", "defend", "flee"],
    "xp": "=10*#level",
    "gp": 0,
    "*terrainModifier": "=lookup(terrainModifier, #terrain)",
    "*aspectModifier": "=lookup(creatureAspects, #animal_aspect)",
    "hp": "=#maxHp"
  },
  "monster": {
    "terrain": "=lookup(terrains, 1d6)",
    "building_type": "=oneOf(mine, fortress, temple, tomb, library)",
    "monster_type": "=if(#building_type == 'tomb', undead, oneOf(giant, demon, elemental, beast, aberration, celestial, construct, fey))",
    "kind": "=lookup(monsterKind, #monster_type)",
    "monster_aspect": "=lookup(creatureAspectTypes, oneOf(uncommon, rare, legendary))",
    "_name": "=capitalize(#monster_aspect) + ' ' + capitalize(#kind)",
    "_statLine": "=lookup(monsterStat, #monster_type)",
    "_statBase": "=lookup(monsterStatBase, #monster_type)",
    "level": 1,
    "str": "=dig(#_statLine, 'str')+#_statBase+round(#level/8)",
    "dex": "=dig(#_statLine, 'dex')+#_statBase+round(#level/8)",
    "con": "=dig(#_statLine, 'con')+#_statBase+round(#level/8)",
    "int": "=dig(#_statLine, 'int')+#_statBase+round(#level/8)",
    "wis": "=dig(#_statLine, 'wis')+#_statBase+round(#level/8)",
    "cha": "=dig(#_statLine, 'cha')+#_statBase+round(#level/8)",
    "maxHp": "=dig(#_statLine, 'hp') + statMod(#con)",
    "weapon": "=lookup(monsterWeapon, #monster_type)",
    "hasMissileWeapon": false,
    "_weaponStat": "=lookup(masterWeapon, #weapon)",
    "damageKind": "=dig(#_weaponStat, 'type')",
    "attackDie": "=dig(#_weaponStat, 'damage')",
    "attacksPerTurn": "=lookup(monsterAttacksPerTurn, #monster_type)",
    "_naturalArmor": "=lookup(monsterNaturalArmor, #monster_type)",
    "ac": "=10 - #_naturalArmor",
    "_baseAbilities": "=lookup(monsterAbilities, #monster_type)",
    "_element": "=if(#monster_type == 'elemental', lookup(elements, #terrain), nihil)",
    "_elementalAbilities": "=if(#monster_type == 'elemental', lookup(elementalAbilities, #_element), nihil)",
    "abilities": "=uniq(concat(#_baseAbilities, #_elementalAbilities))",
    "forename": "=capitalize(#kind)",
    "name": "=if(#monster_type == 'elemental', capitalize(#monster_aspect) + ' ' + capitalize(#_element) + ' ' + capitalize(#kind), #_name)",
    "xp": "=lookup(monsterXp, #monster_type) + 50*#level",
    "gp": "=lookup(monsterGold, #monster_type)",
    "*terrainModifier": "=lookup(terrainModifier, #terrain)",
    "*aspectModifier": "=lookup(creatureAspects, #monster_aspect)",
    "hp": "=#maxHp"
  },
  "npc": {
    "challenging": false,
    "terrain": "=oneOf(forest, cave, swamp, mountain, snow, desert)",
    "race": "=oneOf(goblin, kobold, orc, human, ogre, troll, dragon)",
    "building_type": "=oneOf(mine, fortress, temple, tomb, library)",
    "type": "=oneOf(lookup(npcTypesForDungeon, #building_type))",
    "forename": "=lookup(npcName, #race)",
    "npc_aspect_rarity": "=if(#challenging, oneOf(epic, legendary), oneOf(common, uncommon, rare))",
    "npc_aspect": "=lookup(creatureAspectTypes, #npc_aspect_rarity)",
    "npc_template_type": "=if(#building_type == 'tomb' && #type != 'Necromancer', 'undead', nihil)",
    "npc_template": "=if(#npc_template_type != nihil, lookup(creatureTemplateOverlays, #npc_template_type), nihil)",
    "_class": "=if(#npc_template_type, capitalize(#npc_template) + ' ', '') + capitalize(#npc_aspect) + ' ' + capitalize(#race) + ' ' + #type",
    "name": "=#forename + \", \" + #_class",
    "referenceName": "='the ' + capitalize(#race) + ' ' + #type + oneOf(' named ', ' known as ') + #forename",
    "_statLine": "=lookup(npcStat, #race)",
    "level": 1,
    "str": "=dig(#_statLine, 'str')+round(#level/8)",
    "dex": "=dig(#_statLine, 'dex')+round(#level/8)",
    "con": "=dig(#_statLine, 'con')+round(#level/8)",
    "int": "=dig(#_statLine, 'int')+round(#level/8)",
    "wis": "=dig(#_statLine, 'wis')+round(#level/8)",
    "cha": "=dig(#_statLine, 'cha')+round(#level/8)",
    "_maxHp": "=max(1, dig(#_statLine, 'hp') + statMod(#con))",
    "maxHp": "=if(#challenging, max(30, #_maxHp + #level * 2), #_maxHp + round(#level/4))",
    "_naturalArmor": "=dig(#_statLine, 'naturalArmor')",
    "armor": "=lookup(npcArmor, #race)",
    "_armorBonus": "=lookup(masterArmor, #armor)",
    "ac": "=10 - #_naturalArmor - #_armorBonus",
    "weapon": "=if(#type == 'Slinger', 'sling', lookup(npcWeapon, #race))",
    "_weaponStat": "=lookup(masterWeapon, #weapon)",
    "damageKind": "=dig(#_weaponStat, 'type')",
    "attackDie": "=dig(#_weaponStat, 'damage')",
    "xp": "=lookup(npcXp, #race) + 25*#level",
    "gp": "=lookup(npcGold, #race)",
    "hasMissileWeapon": "=!!dig(#_weaponStat, 'missile')",
    "primaryAttack": "=if(#hasMissileWeapon, 'ranged', 'melee')",
    "_abilities": ["defend", "wait", "flee"],
    "abilities": "=uniq(concat(#primaryAttack, #_abilities))",
    "traits": [],
    "*terrainModifier": "=lookup(terrainModifier, #terrain)",
    "*typeModifier": "=lookup(npcTypeModifier, #type)",
    "*aspectModifier": "=lookup(creatureAspects, #npc_aspect)",
    "*template": "=if(#npc_template != nihil, lookup(creatureTemplateModifiers, #npc_template), nihil)",
    "hp": "=#maxHp"
  },
  "encounter": {
    "race": "=if(#_targetCr <= 5, oneOf(goblin, kobold), if(#_targetCr <= 10, oneOf(orc, human), if(#_targetCr <= 15, oneOf(ogre, troll), oneOf(dragon))))",
    "targetCr": "=#_targetCr",
    "_levelBudget": "=#targetCr",
    "terrain": "=oneOf(forest, cave, swamp, mountain, snow, desert)",
    "_companionCount": 1,
    "_monsterCount": 0,
    "_npcCount": "=1d2",
    "_npcBudget": "=ceil(#_levelBudget * #_npcCount/(#_monsterCount + #_companionCount + #_npcCount))",
    "_npcLevelDistribution": "=distribute(#_npcBudget, #_npcCount)",

    "npc_aspect_rarity": "=if(#targetCr <= 1, 'common', if(#targetCr <= 3, oneOf(common, uncommon), if(#targetCr <= 6, oneOf(uncommon, rare), oneOf(rare, epic))))",

    "_npcs": "=mapGenList(npc, #_npcLevelDistribution, 'level')",
    "bossName": "=dig(#_npcs, 0, 'referenceName')",

    "_monsterBudget": "=floor(#_levelBudget * #_monsterCount/(#_monsterCount + #_companionCount + #_npcCount))",
    "_monsterLevelDistribution": "=distribute(#_monsterBudget, #_monsterCount)",
    "_monsters": "=mapGenList(monster, #_monsterLevelDistribution, 'level')",

    "_companionBudget": "=floor(#_levelBudget * #_companionCount/(#_monsterCount + #_companionCount + #_npcCount))",
    "_companionLevelDistribution": "=distribute(#_companionBudget, #_companionCount)",
    "_companions": "=mapGenList(animal, #_companionLevelDistribution, 'level')",

    "creatures": "=concat(#_npcs, #_companions, #_monsters)",
    "bonusGold": "=2d20 + 5 * count(#creatures)",
    "cr": "=round(sum(#creatures, 'level'))"
  },
  "room": {
    "_targetCr": "1",
    "_index": "0",
    "_roomBias": "=lookup(roomBias, 'temple')",
    "room_type": "=pick(#_roomBias)",
    "narrative": "=lookup(roomNarrative, #room_type)",
    "room_size": "=oneOf(tiny, small, medium, large, enormous)",
    "_encounterChance": "=1",
    "_treasureChance": "=if(#room_type == \"treasury\", 1.0, oneOf(0.5, 0.8))",
    "targetCr": "=#_targetCr + max(0,round(#_index/2)-1)",
    "challenging": false,
    "encounter": "=if(rand() < #_encounterChance, gen(encounter), nihil)",
    "treasure": "=if(rand() < #_treasureChance, lookup(treasure, oneOf(negligible, minor)), nihil)",
    "feature": "=lookup(roomDecoration, 1d100)"
  },
  "boss_room": {
    "_targetCr": 1,
    "depth": 0,
    "race": "goblin",
    "challenging": true,
    "building_type": "=oneOf(temple, fortress, library, tomb, mine)",
    "room_type": "=oneOf(throne_room, lair, altar)",
    "narrative": "=lookup(roomNarrative, #room_type)",
    "room_size": "=oneOf(medium, large, enormous, huge, colossal)",
    "targetCr": "=#_targetCr + round(#depth)",
    "_npcCount": 1,
    "_companionCount": 2,
    "_monsterCount": 1,
    "treasure": "=lookup(treasure, oneOf(major, legendary))",
    "type": "=lookup(bossNpcTypesForDungeon, #building_type)",
    "boss_encounter": "=gen(encounter)",
    "feature": "=lookup(roomDecoration, 1d100)"
  },
  "dungeon": {
    "terrain": "=oneOf(forest, cave, swamp, mountain, snow, desert)",
    "_index": 0,
    "_targetCr": "=max(1, round(1+#_index*1.5))",
    "building_type": "=oneOf(temple, fortress, library, tomb, mine)",
    "__building_type": "tomb",
    "_roomBias": "=lookup(roomBias, #building_type)",
    "dungeon_type": "=lookup(dungeonTypes, #building_type)",
    "race": "=if(#_targetCr <= 5, oneOf(goblin, kobold), if(#_targetCr <= 10, oneOf(orc, human), if(#_targetCr <= 15, oneOf(ogre, troll), oneOf(dragon))))",
    "theme": "=oneOf(pain, power, darkness, nature, fire, ice, shadow, light, chaos, order, water, air, earth, lightning, death, life, time, mystery)",
    "dungeon_aspect": "=lookup(dungeonAspect, #building_type)",
    "dungeon_name": "=capitalize(#dungeon_aspect) + \" \" + capitalize(#race) + \" \" + capitalize(#dungeon_type) + \" of \" + capitalize(#theme)",
    "depth": "=4+2d4",
    "dungeonIndex": "=#_index",
    "intendedCr": "=#_targetCr",
    "rooms": "=genList(room, #depth)",
    "bossRoom": "=gen(boss_room)",
    "direction": "=oneOf(north, south, east, west)",
    "bossName": "=dig(#bossRoom, 'boss_encounter', 'bossName')",
    "rumor": "=eval(lookup(dungeonRumor, #building_type))"
  },
  
  "module": {
    "terrain": "=lookup(terrains, 1d6)",
    "town": "=gen(town)",
    "_townName": "=dig(#town, 'name')",
    "dungeons": "=genList(dungeon, 16)",
    "name": "=oneOf('Adventure', 'Saga', 'Reckoning', 'Quest', 'Expedition') + ' ' + oneOf('in the ' + capitalize(#terrain), 'at ' + capitalize(#_townName), 'for the ' + capitalize(#terrain))"
  }
}